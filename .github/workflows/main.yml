name: Deploy to App Engine

on:
  push:
    branches: [main] # Deploy on pushes to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # Authenticate using service account
    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with: 
        service_account: 'app-engine-deployer@acnescan-final.iam.gserviceaccount.com'
        credentials_json: '${{ secrets.GOOGLE_CLOUD_KEY }}'

    # Set environment variables
    - name: Set environment variables
      run: |
        export DB_USERNAME=${{ secrets.DB_USERNAME }}
        export DB_HOST=${{ secrets.DB_HOST }}
        export DB_PORT=${{ secrets.DB_PORT }}
        export DB_NAME=${{ secrets.DB_NAME }}
        export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        export JWT_SECRET=${{ secrets.JWT_SECRET }}
        export BUCKET_NAME=${{ secrets.BUCKET_NAME }}
        export GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}


    # Set up Google Cloud SDK
    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    # Deploy to Google App Engine
    - name: Deploy to App Engine
      run: |
        gcloud app deploy app.yaml --quiet
